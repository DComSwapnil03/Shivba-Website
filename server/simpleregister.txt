const express = require('express');
const crypto = require('crypto');
const nodemailer = require('nodemailer');
// We assume InterestRegistration model is correctly handled in server.js's safeRequire
const InterestRegistration = require('../models/InterestRegistration'); 

const router = express.Router();

// --- 1. CONFIGURATION CHECKS (CRITICAL ENVIRONMENT VARS) ---

if (!process.env.MAIL_USER || !process.env.MAIL_PASS) {
    console.error('âŒ FATAL: SMTP credentials (MAIL_USER or MAIL_PASS) are not set. Email functionality disabled.');
    // In a production server, you might want to exit the process or use a placeholder mailer
    // For now, we will throw a clear error to halt the process if mail is crucial for registration
    if (process.env.NODE_ENV !== 'development') {
        throw new Error('Missing SMTP credentials. Cannot initialize mailer.');
    }
}

/**
 * 1. SINGLE Mailer configuration (used everywhere)
 */
// NOTE: nodemailer.createTransport can throw an error if configuration is severely malformed.
const mailer = nodemailer.createTransport({
Â  host: process.env.SMTP_HOST || 'smtp.gmail.com',
Â  port: Number(process.env.SMTP_PORT) || 587,
Â  // Explicitly check if the port is 465 for 'secure' flag
Â  secure: Number(process.env.SMTP_PORT) === 465,
Â  auth: {
Â  Â  user: process.env.MAIL_USER,
Â  Â  pass: process.env.MAIL_PASS
Â  },
Â  // Tweak TLS setting for safety/development flexibility
Â  tls: {
Â  Â  rejectUnauthorized: process.env.NODE_ENV !== 'development' && Number(process.env.SMTP_PORT) !== 587 // Only reject unauthorized in prod, unless port is 587
Â  }
});

// Verify connection immediately
mailer.verify((error, success) => {
    if (error) {
        console.error('âŒ Mailer connection verification failed:', error.message);
        // Do NOT crash the server here, as it might connect later, but alert the developer
    } else {
        console.log('âœ… Mailer ready to send messages');
    }
});


/**
 * 2. SINGLE Email verification method (used for OTP + link)
 */
async function sendVerificationEmail({ to, name, token, otp }) {
Â  console.log(`[Email] Sending verification to: ${to}`);
Â  
Â  const baseUrl = process.env.CLIENT_BASE_URL || 'http://localhost:3000';
Â  const verifyUrl = `${baseUrl}/verify?token=${token}&email=${encodeURIComponent(to)}`;

Â  try {
Â  Â  // Check environment variables crucial for email
    if (!process.env.MAIL_FROM && !process.env.MAIL_USER) {
        throw new Error('MAIL_FROM or MAIL_USER environment variable is missing.');
    }

Â  Â  const info = await mailer.sendMail({
Â  Â  Â  from: process.env.MAIL_FROM || process.env.MAIL_USER,
Â  Â  Â  to,
Â  Â  Â  subject: 'Your Shivba Verification Code',
Â  Â  Â  html: `
Â  Â  Â  Â  <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 600px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px;">
Â  Â  Â  Â  Â  <h2 style="color: #ffffff; text-align: center;">Welcome to Shivba, ${name}!</h2>
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  <div style="background: rgba(255,255,255,0.95); padding: 2rem; border-radius: 12px; margin: 1rem 0; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
Â  Â  Â  Â  Â  Â  <h1 style="background: linear-gradient(135deg, #ec4899, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 3.5rem; font-weight: 800; letter-spacing: 12px; text-align: center; margin: 1rem 0;">${otp}</h1>
Â  Â  Â  Â  Â  Â  <p style="color: #4b5563; font-size: 1.1rem; text-align: center; line-height: 1.6;">
Â  Â  Â  Â  Â  Â  Â  Your verification code (expires in 10 minutes)
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div style="text-align: center; margin: 2rem 0;">
Â  Â  Â  Â  Â  Â  <a href="${verifyUrl}" style="background: linear-gradient(135deg, #ec4899, #f472b6); color: white; padding: 12px 32px; text-decoration: none; border-radius: 50px; font-weight: 600; font-size: 1.1rem; box-shadow: 0 8px 24px rgba(236, 72, 153, 0.4);">Verify Now</a>
Â  Â  Â  Â  Â  Â  <p style="color: #9ca3af; font-size: 0.9rem; margin-top: 1rem;">
Â  Â  Â  Â  Â  Â  Â  Or copy this code: <strong>${otp}</strong>
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <hr style="border: none; height: 1px; background: rgba(255,255,255,0.2); margin: 2rem 0;">
Â  Â  Â  Â  Â  <p style="color: #e2e8f0; font-size: 0.85rem; text-align: center;">
Â  Â  Â  Â  Â  Â  Didn't request this? Ignore this email.
Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  <p style="color: #fbbf24; font-weight: 600; text-align: center;">
Â  Â  Â  Â  Â  Â  Shivba Team
Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  </div>
Â  Â  Â  `
Â  Â  });
Â  Â  
Â  Â  console.log(`âœ… Email sent! ID: ${info.messageId}`);
Â  Â  return info;
Â  } catch (error) {
Â  Â  console.error('âŒ Email failed:', error);
Â  Â  // Re-throwing the error ensures the calling function (/register-interest-simple) 
    // knows the email failed and can respond with a 500 status.
Â  Â  throw error; 
Â  }
}

/**
 * 3. POST /api/register-interest-simple - Register + Send OTP
 */
router.post('/register-interest-simple', async (req, res) => {
Â  console.log('ğŸ“ New registration attempt');
Â  
Â  try {
Â  Â  const { name, email, phone } = req.body;
    
    // --- Input Validation ---
Â  Â  if (!name?.trim() || !email?.trim() || !phone?.trim()) {
Â  Â  Â  return res.status(400).json({ 
Â  Â  Â  Â  message: 'Please provide name, email, and phone.' 
Â  Â  Â  });
Â  Â  }

    // Basic email format check (optional but recommended)
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email.trim())) {
        return res.status(400).json({ message: 'Invalid email format.' });
    }

Â  Â  const lowerEmail = email.toLowerCase().trim();

Â  Â  // Generate secure OTP + token
Â  Â  const otp = crypto.randomInt(100000, 999999).toString();
Â  Â  const token = crypto.randomBytes(32).toString('hex');
Â  Â  const expiresAt = new Date(Date.now() + 10 * 60 * 1000); // 10 min

Â  Â  // Save/upsert registration
Â  Â  const user = await InterestRegistration.findOneAndUpdate(
Â  Â  Â  { email: lowerEmail },
Â  Â  Â  {
Â  Â  Â  Â  name: name.trim(),
Â  Â  Â  Â  email: lowerEmail,
Â  Â  Â  Â  phone: phone.trim(),
Â  Â  Â  Â  eventName: 'General Interest',
Â  Â  Â  Â  amount: 0,
Â  Â  Â  Â  isVerified: false,
Â  Â  Â  Â  verifyToken: token, Â  Â  Â // For link verification
Â  Â  Â  Â  verifyTokenExpiresAt: expiresAt
Â  Â  Â  },
Â  Â  Â  { 
          upsert: true, 
          new: true, 
          setDefaultsOnInsert: true,
          // Add runValidators: true if you have Mongoose schema validators
          // runValidators: true 
      }
Â  Â  );

Â  Â  console.log(`ğŸ’¾ Saved registration for ${lowerEmail}`);

Â  Â  // Send verification email (SINGLE method)
Â  Â  await sendVerificationEmail({ to: lowerEmail, name: name.trim(), token, otp });

Â  Â  return res.status(201).json({
Â  Â  Â  success: true,
Â  Â  Â  message: 'Verification code sent to your email!',
Â  Â  Â  email: lowerEmail,
Â  Â  Â  nextStep: 'verify'
Â  Â  });

Â  } catch (error) {
Â  Â  console.error('âŒ Registration error:', error);

    // Differentiate between Mongoose/DB error and other errors
    let errorMessage = 'Registration failed. Please try again.';
    if (error.name === 'MongoServerError' && error.code === 11000) {
        // Handle duplicate key error (if you have unique indexes other than email)
        errorMessage = 'This entry already exists (Duplicate Key Error).';
    } else if (error.name === 'ValidationError') {
        // Handle Mongoose validation error (if you use runValidators: true)
        errorMessage = error.message; 
    } else if (error.message.includes('Mailer connection') || error.message.includes('SMTP')) {
        // Explicitly catch mailer issues bubbled up from sendVerificationEmail
        errorMessage = 'Registration saved, but failed to send verification email.';
    }

Â  Â  return res.status(500).json({ 
Â  Â  Â  message: errorMessage 
Â  Â  });
Â  }
});

/**
 * 4. POST /api/verify-otp - Verify code OR token
 */
router.post('/verify-otp', async (req, res) => {
Â  console.log('ğŸ” Verification attempt');
Â  
Â  try {
Â  Â  const { email, otp, token } = req.body;
Â  Â  
    // --- Input Validation ---
Â  Â  if (!email || (!otp && !token)) {
Â  Â  Â  return res.status(400).json({ 
Â  Â  Â  Â  message: 'Email and (OTP or token) are required.' 
Â  Â  Â  });
Â  Â  }

Â  Â  const lowerEmail = email.toLowerCase().trim();

Â  Â  // Find user by OTP OR token (both expire at same time)
Â  Â  const user = await InterestRegistration.findOne({
Â  Â  Â  email: lowerEmail,
Â  Â  Â  $or: [
Â  Â  Â  Â  { verifyToken: otp },
Â  Â  Â  Â  { verifyToken: token }
Â  Â  Â  ],
Â  Â  Â  // Check if the token/otp is still valid (greater than current date)
Â  Â  Â  verifyTokenExpiresAt: { $gt: new Date() }
Â  Â  });

Â  Â  if (!user) {
Â  Â  Â  return res.status(400).json({ 
Â  Â  Â  Â  message: 'Invalid or expired verification code.' 
Â  Â  Â  });
Â  Â  }

Â  Â  // Mark verified and cleanup
Â  Â  user.isVerified = true;
Â  Â  user.verifyToken = undefined;
Â  Â  user.verifyTokenExpiresAt = undefined;
Â  Â  await user.save(); // Save operation can throw an error

Â  Â  console.log(`âœ… Verified ${lowerEmail}`);

Â  Â  return res.json({
Â  Â  Â  success: true,
Â  Â  Â  message: 'Email verified successfully!',
Â  Â  Â  user: {
Â  Â  Â  Â  name: user.name,
Â  Â  Â  Â  email: user.email,
Â  Â  Â  Â  phone: user.phone,
Â  Â  Â  Â  isVerified: true
Â  Â  Â  }
Â  Â  });

Â  } catch (error) {
Â  Â  console.error('âŒ Verification error:', error);
Â  Â  // General server error response for verification failures
Â  Â  return res.status(500).json({ 
Â  Â  Â  message: 'Verification failed due to a server error. Please try again.' 
Â  Â  });
Â  }
});

module.exports = router;